---
- name: Configure Cisco switches
  hosts: all
  gather_facts: no
  collections:
    - cisco.ios

  tasks:

    # 1. Enable secret
    - name: Configure enable secret password
      ios_config:
        lines:
          - "enable secret {{ enable_secret | default('cisco') }}"
      when: enable_secret is defined or enable_secret is not defined

    # 2. Console line password
    - name: Configure console line password
      ios_config:
        parents: "line console 0"
        lines:
          - "password {{ console_password | default('cisco') }}"
          - "login"
      when: console_password is defined or console_password is not defined

    # 3. Banner
    - name: Configure login banner
      ios_banner:
        banner: login
        text: "{{ banner_login | default(default_banner) }}"
        state: present
      vars:
        default_banner: |
          ****************************************
          *  UNAUTHORIZED ACCESS IS PROHIBITED  *
          *    Authorized users only!           *
          ****************************************

    # 4. VLAN-и
    - name: Configure VLANs
      ios_config:
        parents: "vlan {{ item.id }}"
        lines:
          - "name {{ item.name }}"
      loop: "{{ vlans | default([]) }}"
      when: vlans is defined and (vlans | length) > 0

    # 5. Access-порти
    - name: Configure access ports
      ios_config:
        parents: "interface {{ item.interface }}"
        lines:
          - "switchport mode access"
          - "switchport access vlan {{ item.vlan }}"
          - "spanning-tree portfast"
      loop: "{{ access_ports | default([]) }}"
      when: access_ports is defined and (access_ports | length) > 0

    # 6. Trunk-порти (з encapsulation)
    - name: Configure trunk ports
      ios_config:
        parents: "interface {{ item.interface }}"
        lines:
          - "switchport trunk encapsulation dot1q"
          - "switchport mode trunk"
          - "switchport trunk allowed vlan {{ item.vlans }}"
      loop: "{{ trunk_ports | default([]) }}"
      when: trunk_ports is defined and (trunk_ports | length) > 0

    # 7. Локальні користувачі
    - name: Configure local users
      ios_config:
        lines:
          - "username {{ item.username }} privilege {{ item.privilege | default(15) }} secret {{ item.secret }}"
      loop: "{{ users | default([]) }}"
      when: users is defined and (users | length) > 0

    # 8. Налаштування віддаленого доступу (line vty)
    - name: Configure remote access on vty lines
      ios_config:
        parents: "line vty 0 4"
        lines:
          - "login local"
          - "transport input {{ transport }}"
      vars:
        transport: >-
          {% if remote_access == 'all' %}ssh telnet
          {% elif remote_access == 'ssh' %}ssh
          {% elif remote_access == 'telnet' %}telnet
          {% elif remote_access == 'none' %}none
          {% else %}ssh{% endif %}
      when: remote_access is defined and remote_access | length > 0
